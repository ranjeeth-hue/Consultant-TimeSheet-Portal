<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Approval History</title>
  <base target="_top">
  <style>
    body{font-family:Arial;background:#eef2f3;margin:0;padding:28px;}
    .wrap{width:900px;margin:0 auto;}
    h2{color:#0b57b7;margin-bottom:6px;}
    .user{color:#0b57b7;font-weight:700;margin-bottom:12px;}
    .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 28px rgba(0,0,0,0.06);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;}
    .tag{padding:6px 10px;border-radius:8px;color:#fff;font-weight:700;}
    .approved{background:green;} .rejected{background:red;} .pending{background:orange;color:#000;}
    .back{margin-top:12px;padding:10px 14px;background:#0b57b7;color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .weekly{margin:12px 6px;padding:8px 12px;background:#0b57b7;color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .smallbtn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer;margin-right:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Approval History & Weekly Status</h2>
    <div id="userLine" class="user"></div>

    <div style="margin-bottom:12px;">
      <button class="weekly" onclick="loadWeekly(0)">This Week</button>
      <button class="weekly" onclick="loadWeekly(-1)">Last Week</button>
    </div>

    <div id="weeklyBox" class="card" style="margin-top:14px;">
      <div id="weekTitle" style="font-weight:700;margin-bottom:8px;"></div>
      <div id="weekSummary" style="font-weight:700;margin-bottom:8px;"></div>
      <table id="weekTbl" style="width:100%;border-collapse:collapse;">
        <thead><tr><th>Date</th><th>Project</th><th>Total Hours</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="weekBody"></tbody>
      </table>
    </div>

    <div style="height:18px;"></div>

    <div class="card" style="margin-top:12px;">
      <h3>All Approval History</h3>
      <table id="allTbl" style="width:100%;border-collapse:collapse;">
        <thead><tr><th>Date</th><th>Project</th><th>Total Hours</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="allBody"></tbody>
      </table>
    </div>

    <button class="back" onclick="back()">Back to Dashboard</button>
  </div>

<script>
  const WEB_APP = "https://script.google.com/macros/s/AKfycbyScrDWFhDbDS_ZUakPfRgsz6erSkcwMw2dyNXLxvFHMtq-zvfDGJHAhqkvOU2u9p01/exec";
  const username = localStorage.getItem("ts_username");
  if(!username){ alert("Please login"); window.location.href="Timesheet_Login.html"; }
  document.getElementById("userLine").innerText = "User: " + username;

  // load all (this user's entries)
  function loadAll(){
    fetch(WEB_APP, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ type:"fetchStatus", username: username })
    })
    .then(r=>r.json())
    .then(arr=>{
      const allBody = document.getElementById("allBody");
      allBody.innerHTML = "";
      if(!arr || arr.length===0){ allBody.innerHTML = "<tr><td colspan='5' style='text-align:center;padding:12px;color:#777;'>No entries found</td></tr>"; return; }
      arr.forEach(r=>{
        const status = r.status || "Pending";
        const cls = status.toLowerCase()==="approved" ? "approved" : status.toLowerCase()==="rejected" ? "rejected" : "pending";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.project}</td><td>${r.totalHours}</td><td><span class="tag ${cls}">${status}</span></td>
                        <td>
                          <button class="smallbtn" onclick='openApprove(${r.rowNum},"${escape(r.date)}","${escape(r.project)}","${r.totalHours}")'>Approve/Reject</button>
                        </td>`;
        allBody.appendChild(tr);
      });
    })
    .catch(e=>{ console.error(e); alert("Network error"); });
  }

  // weekly load (offsetWeeks: 0 this week, -1 last week)
  function getWeekRange(offsetWeeks=0){
    const today = new Date();
    today.setDate(today.getDate() + (offsetWeeks * 7));
    const day = today.getDay(); // 0 Sunday .. 6 Saturday
    const diffToMon = (day === 0) ? -6 : (1 - day);
    const mon = new Date(today); mon.setDate(today.getDate() + diffToMon);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    function ymd(d){ return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + String(d.getDate()).padStart(2,'0'); }
    return { start: ymd(mon), end: ymd(sun), title: `${ymd(mon)} to ${ymd(sun)}` };
  }

  function loadWeekly(offsetWeeks=0){
    const range = getWeekRange(offsetWeeks);
    document.getElementById("weekTitle").innerText = "Week: " + range.title;
    fetch(WEB_APP, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ type:"fetchWeekly", username: username, weekStart: range.start, weekEnd: range.end })
    })
    .then(r=>r.json())
    .then(obj=>{
      document.getElementById("weekSummary").innerText = "Total Hours: " + (obj.totalHours || 0);
      const body = document.getElementById("weekBody");
      body.innerHTML = "";
      if(!obj.rows || obj.rows.length===0){ body.innerHTML = "<tr><td colspan='5' style='text-align:center;padding:12px;color:#777;'>No entries for this week</td></tr>"; return; }
      obj.rows.forEach(r=>{
        const status = r.status || "Pending";
        const cls = status.toLowerCase()==="approved" ? "approved" : status.toLowerCase()==="rejected" ? "rejected" : "pending";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.project}</td><td>${r.totalHours}</td><td><span class="tag ${cls}">${status}</span></td>
                        <td><button class="smallbtn" onclick='openApprove(${r.rowNum},"${escape(r.date)}","${escape(r.project)}","${r.totalHours}")'>Approve/Reject</button></td>`;
        body.appendChild(tr);
      });
    })
    .catch(e=>{ console.error(e); alert("Network error"); });
  }

  // open approval prompt
  function openApprove(rowNum, dateEsc, projectEsc, hrs){
    const date = unescape(dateEsc);
    const project = unescape(projectEsc);
    const approver = prompt("Enter your name (approver):");
    if(approver === null) return; // cancelled
    const comment = prompt(`Add comment (optional) for\nDate: ${date}\nProject: ${project}\nHours: ${hrs}`);
    if(comment === null) return;
    const action = confirm("Click OK to Approve, Cancel to Reject") ? "Approved" : "Rejected";

    fetch(WEB_APP, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ type:"approveAction", rowNum: rowNum, action: action, approver: approver, comment: comment })
    })
    .then(r=>r.text())
    .then(t=>{
      if(t==="SUCCESS"){ alert("Action saved"); loadAll(); loadWeekly(0); } else { alert("Server: "+t); }
    })
    .catch(e=>{ console.error(e); alert("Network error"); });
  }

  function back(){ window.location.href = "Dashboard.html"; }

  // initial load
  window.onload = function(){
    loadAll();
    loadWeekly(0);
  };
</script>
</body>
</html>
